import { useMemoizedFn } from 'ahooks'
import { Play, Settings, Square } from 'lucide-react'
import { useState } from 'react'
import { GateButton } from '@/components/GateButton'
import { Button } from '@/components/ui/button'
import { Checkbox } from '@/components/ui/checkbox'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover'
import { Separator } from '@/components/ui/separator'
import {
  getAutoStartOnLive,
  setAutoStartOnLive,
  useAutoStartOnLive,
} from '@/hooks/useAutoStartOnLive'
import { useLiveFeatureGate } from '@/hooks/useLiveFeatureGate'
import { useOneClickStart } from '@/hooks/useOneClickStart'

const SKIP_CONFIRM_KEY = 'one-click-start-skip-confirm'

function getSkipConfirm(): boolean {
  try {
    return localStorage.getItem(SKIP_CONFIRM_KEY) === 'true'
  } catch {
    return false
  }
}

function setSkipConfirm(value: boolean): void {
  try {
    localStorage.setItem(SKIP_CONFIRM_KEY, value ? 'true' : 'false')
  } catch {
    // ignore
  }
}

// 统一按钮尺寸样式
const BUTTON_HEIGHT = 'h-12'
const BUTTON_TEXT = 'text-base font-semibold'
const ICON_BUTTON_SIZE = 'h-12 w-12'

export function OneClickStartButton() {
  const { state, startAllTasks, stopAllTasks, isAnyTaskRunning } = useOneClickStart()
  const gate = useLiveFeatureGate()
  const [showConfirm, setShowConfirm] = useState(false)
  const [skipConfirm, setSkipConfirmState] = useState(getSkipConfirm())
  const [autoStartOnLive, setAutoStartOnLiveState] = useState(getAutoStartOnLive())
  const [settingsOpen, setSettingsOpen] = useState(false)

  // 启用开播自动启动监听
  useAutoStartOnLive()

  const handleClick = useMemoizedFn(() => {
    if (!state.canStart) {
      return
    }
    // 如果用户选择跳过确认，直接启动
    if (skipConfirm) {
      startAllTasks()
      return
    }
    setShowConfirm(true)
  })

  const handleConfirm = useMemoizedFn(async () => {
    setShowConfirm(false)
    await startAllTasks()
  })

  const handleCancel = useMemoizedFn(() => {
    setShowConfirm(false)
  })

  const handleSkipConfirmChange = useMemoizedFn((checked: boolean) => {
    setSkipConfirmState(checked)
    setSkipConfirm(checked)
  })

  const handleAutoStartOnLiveChange = useMemoizedFn((checked: boolean) => {
    setAutoStartOnLiveState(checked)
    setAutoStartOnLive(checked)
  })

  if (isAnyTaskRunning) {
    return (
      <div className="flex items-center gap-0">
        <Button
          variant="destructive"
          onClick={stopAllTasks}
          className={`gap-2 rounded-r-none ${BUTTON_HEIGHT} ${BUTTON_TEXT}`}
        >
          <Square className="w-4 h-4" />
          停止所有任务
        </Button>
        <Button
          variant="destructive"
          size="icon"
          className={`rounded-l-none border-l border-destructive-foreground/20 ${ICON_BUTTON_SIZE} opacity-50 cursor-not-allowed`}
          disabled
        >
          <Settings className="w-4 h-4" />
        </Button>
      </div>
    )
  }

  return (
    <>
      <div className="flex items-center gap-0">
        <GateButton
          gate={gate}
          onClick={handleClick}
          disabled={state.isLoading}
          className={`gap-2 rounded-r-none ${BUTTON_HEIGHT} ${BUTTON_TEXT}`}
        >
          <Play className="w-4 h-4" />
          一键开启任务
        </GateButton>

        <Popover open={settingsOpen} onOpenChange={setSettingsOpen}>
          <PopoverTrigger asChild>
            <Button
              variant="default"
              size="icon"
              className={`rounded-l-none border-l border-primary-foreground/20 ${ICON_BUTTON_SIZE}`}
              disabled={state.isLoading}
            >
              <Settings className="w-4 h-4" />
            </Button>
          </PopoverTrigger>
          <PopoverContent align="end" className="w-56 p-3">
            <div className="space-y-3">
              <h4 className="font-medium text-sm">自动启动设置</h4>
              <Separator />
              <div className="space-y-2">
                <label className="flex items-center space-x-2 cursor-pointer">
                  <Checkbox
                    checked={autoStartOnLive}
                    onCheckedChange={handleAutoStartOnLiveChange}
                  />
                  <span className="text-sm">开播自动启动</span>
                </label>
                <label className="flex items-center space-x-2 cursor-pointer">
                  <Checkbox
                    checked={skipConfirm}
                    onCheckedChange={handleSkipConfirmChange}
                  />
                  <span className="text-sm">跳过确认提示</span>
                </label>
              </div>
            </div>
          </PopoverContent>
        </Popover>
      </div>

      <Dialog open={showConfirm} onOpenChange={setShowConfirm}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>确认开启所有任务？</DialogTitle>
            <DialogDescription className="space-y-2 pt-4">
              <p>将同时开启以下功能：</p>
              <ul className="list-disc list-inside space-y-1 text-muted-foreground">
                <li>自动回复 - 自动回复观众评论</li>
                <li>自动发言 - 按设定间隔自动发送消息</li>
                <li>自动弹窗 - 自动展示商品弹窗</li>
              </ul>
              <p className="text-sm text-amber-500 mt-4">
                请确保已配置好各功能的设置后再开启。
              </p>
            </DialogDescription>
          </DialogHeader>
          <div className="flex items-center space-x-2 py-4">
            <Checkbox
              id="skip-confirm"
              checked={skipConfirm}
              onCheckedChange={handleSkipConfirmChange}
            />
            <label
              htmlFor="skip-confirm"
              className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer"
            >
              我已知晓，下次不再提醒
            </label>
          </div>
          <DialogFooter className="gap-2 sm:gap-0">
            <Button variant="outline" onClick={handleCancel}>
              取消
            </Button>
            <Button onClick={handleConfirm} className="gap-2">
              <Play className="w-4 h-4" />
              确认开启
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  )
}
